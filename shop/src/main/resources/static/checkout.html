<!DOCTYPE html>
<html lang="en">
<!-- Basic -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Metas -->
    <title>checkout</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/custom.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/holder.js" defer></script>

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>



    <!-- Start Main Top -->
    <header class="main-header">
        <!-- Start Navigation -->
        <div id="navPlaceholder"></div>
        <!-- End Navigation -->
    </header>
    <!-- End Main Top -->


    <!-- Start All Title Box -->
    <div class="all-title-box">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h2>Checkout</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active">Checkout</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- End All Title Box -->

    <!-- Start Cart  -->
    <div class="cart-box-main">
        <div class="container">

            <div class="row">
                <div class="col-sm-6 col-lg-6 mb-3">
                    <div class="checkout-address" id="billingAddressId">
                        
                    </div>
                </div>
                <div class="col-sm-6 col-lg-6 mb-3">
                    <div class="row">
                        <div class="col-md-12 col-lg-12">
                        </div>
                        <div class="col-md-12 col-lg-12">
                            <div class="odr-box">
                                <div class="title-left">
                                    <h3>Shopping cart</h3>
                                </div>
                                <div class="rounded p-2 bg-light" id="shoppingCartId">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-lg-12">
                            <div class="order-box" id="yourOrderId">
                                <hr> </div>
                        </div>
                        <div class="col-12 d-flex shopping-box"> 
                            <a href="checkout.html" id = "checkOutId" class="ml-auto btn hvr-hover">Place Order</a> 
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- End Cart -->

    <!-- Start Instagram Feed  -->
    <div class="instagram-box">
    <div class="main-instagram owl-carousel owl-theme">
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-01.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-02.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-03.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-04.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-05.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-06.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-07.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-08.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-09.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="item">
            <div class="ins-inner-box">
                <img src="../images/instagram-img-05.jpg" alt="" />
                <div class="hov-in">
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- End Instagram Feed  -->


    <!-- Start Footer  -->
    <div id="mainfooterplaceholder"></div>
    <!-- End Footer  -->

    <!-- Start copyright  -->
    <!-- Start copyright  -->
    <div class="footer-copyright">
        <p class="footer-company">All Rights Reserved. &copy; 2025 <a href="#"> Try & Buy</a>
    </div>
    <!-- End copyright  -->
    <!-- End copyright  -->

    <a href="#" id="back-to-top" title="Back to top" style="display: none;">&uarr;</a>

    <script>
        $(document).ready(function(){
            addShippingCart();
            userInformation();
            checkout();
            getNumberOfProducts();

        



function addOrder(totalAmount, shippingCost, grandTotal){ 

    console.log("totalAmount:  ", totalAmount)
    let yourOrderData = `
    <div class="title-left">
        <h3>Your order</h3>
    </div>
    <div class="d-flex">
        <div class="font-weight-bold">Product</div>
        <div class="ml-auto font-weight-bold">Total</div>
    </div>
    <hr class="my-1">
    <div class="d-flex">
        <h4>Sub Total</h4>
        <div class="ml-auto font-weight-bold"> $ ${totalAmount} </div>
    </div>
    <hr class="my-1">
    
    <div class="d-flex">
        <h4>Shipping Cost</h4>
        <div class="ml-auto font-weight-bold"> $ ${shippingCost} </div>
    </div>
    <hr>
    <div class="d-flex gr-total">
        <h5>Grand Total</h5>
        <div class="ml-auto h5"> $ ${grandTotal} </div>
    </div>
    `
    $('#yourOrderId').html(yourOrderData)
}
      

function addShippingCart(){
    let checkoutData = ''
    $.ajax({
        url: "http://localhost:8080/Car/user",
        type: "GET",
        headers: getAuthHeaders(),
        success: function(data){
            let productsInShoppingCart = data.ProductsOfCarDto
            let shippingCost = data.shippingCost ? data.shippingCost : 'Free'
            let grandTotal = data.grandTotal ? data.grandTotal : 0

            console.log("Carrrrr: ", data)

            productsInShoppingCart.forEach(product => {
                checkoutData += `
                    <div class="media mb-2 border-bottom">
                        <div class="media-body"> <a href="detail.html"> ${product.productName}</a>
                            <div class="small text-muted">Price: $ ${product.productPrice} <span class="mx-2">|</span> Qty: ${product.quantity} <span class="mx-2">|</span> Subtotal: $ ${product.allPrice}</div>
                        </div>
                    </div>
                `
            });
            $('#shoppingCartId').html(checkoutData)
            addOrder(data.totalAmount, shippingCost, grandTotal);
            

        },
        error: function(xhr, status, error){
            console.log("Error in getCartInfo: ", error)
        }
    });
}


function userInformation(){
    $.ajax({
        url: "http://localhost:8080/User/account",
        type: "GET",
        headers: getAuthHeaders(),
        success: function(data){
            console.log("DATAAA: ", data)
            let billingAddressData = `
                <div class="title-left">
                    <h3>Billing address</h3>
                </div>
                <form class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fullname">First name </label>
                            <input type="text" class="form-control" id="fullname" placeholder="" value="${data.fullname}" readonly>
                            <div class="invalid-feedback"> Valid first name is required. </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="username">Last name </label>
                            <input type="text" class="form-control" id="username" placeholder="" value="${data.username}" readonly required>
                            <div class="invalid-feedback"> Valid last name is required. </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email">Email Address </label>
                        <input type="email" class="form-control" id="email" placeholder="" value = "${data.email}" readonly >
                        <div class="invalid-feedback"> Please enter a valid email address for shipping updates. </div>
                    </div>
                    <div class="mb-3">
                        <label for="phone">Phone Number </label>
                        <input type="text" class="form-control" id="phone" placeholder="" value="${data.phone}" readonly >
                        <div class="invalid-feedback"> Please enter your phone. </div>
                    </div>
                    <div class="mb-3">
                        <label for="address">Address *</label>
                        <input type="text" class="form-control" id="address" placeholder="" value="${data.address}" required>
                        <div class="invalid-feedback"> Please enter your shipping address. </div>
                    </div>
                    <div class="row" id="locationsId">
                        
                    </div>
                    
                </form>
            `
            $("#billingAddressId").html(billingAddressData)
            location()
        },
        error: function(xhr, status, error){
            console.log("Error in get user: ", error)
        }
    });
}


function location(){
    $.ajax({
        url: "http://localhost:8080/Car/getLocations",
        type: "GET",
        headers: getAuthHeaders(),
        success: function (data) {
            console.log("Locations: ", data);

            let locationData = `
                <div class="col-md-5 mb-3">
                    <label for="country">Country *</label>
                    <select class="wide w-100" id="country">
                        <option value="">Select Country</option>
                    </select>
                    <div class="invalid-feedback"> Please select a valid country. </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="state">State *</label>
                    <select class="wide w-100" id="state">
                        <option value="">Select State</option>
                    </select>
                    <div class="invalid-feedback"> Please provide a valid state. </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="zip">Zip *</label>
                    <select class="wide w-100" id="zip">
                        <option value="">Select Zip</option>
                    </select>
                    <div class="invalid-feedback"> Zip code required. </div>
                </div>
            `;
            $('#locationsId').html(locationData);

            const countrySelect = document.getElementById("country");
            const stateSelect = document.getElementById("state");
            const zipSelect = document.getElementById("zip");

            // Fill country select with unique countries
            const uniqueCountries = [...new Set(data.map(loc => loc.country))];
            uniqueCountries.forEach(country => {
                let option = document.createElement("option");
                option.value = country;
                option.textContent = country;
                countrySelect.append(option);
            });

            // On country change
            countrySelect.addEventListener("change", function () {
                const selectedCountry = this.value;
                stateSelect.innerHTML = `<option value="">Select State</option>`;
                zipSelect.innerHTML = `<option value="">Select Zip</option>`;

                const filteredStates = data.filter(loc => loc.country === selectedCountry);
                const uniqueStates = [...new Set(filteredStates.map(loc => loc.state))];

                uniqueStates.forEach(state => {
                    let option = document.createElement("option");
                    option.value = state;
                    option.textContent = state;
                    stateSelect.append(option);
                });
            });

            // On state change
            stateSelect.addEventListener("change", function () {
                const selectedCountry = countrySelect.value;
                const selectedState = this.value;
                zipSelect.innerHTML = `<option value="">Select Zip</option>`;

                const filteredZips = data.filter(loc =>
                    loc.country === selectedCountry && loc.state === selectedState
                );
                const uniqueZips = [...new Set(filteredZips.map(loc => loc.zip))];

                uniqueZips.forEach(zip => {
                    let option = document.createElement("option");
                    option.value = zip;
                    option.textContent = zip;
                    zipSelect.append(option);
                });
            });
        },
        error: function (xhr, status, error) {
            console.log("Error in location : ", error);
        }
    });
}


function checkout(){           
    $('#checkOutId').on('click', function (e) {
        e.preventDefault();
        const country = $('#country').val();
        const state = $('#state').val();
        const zip = $('#zip').val();
        const address = $('#address').val();

        if (country && state && zip && address) {
            $.ajax({
                url: "http://localhost:8080/Car/saveLocation",
                type: "POST",
            contentType: "application/json",
            dataType: "json",
            headers: getAuthHeaders(),
            data: JSON.stringify({ country, state, zip, address }),
            success: function (data) {
                console.log("Location saved:", data);

                $.ajax({
                    url: "http://localhost:8080/Car/buy",
                    type: "POST",
                    headers: getAuthHeaders(),
                    success: function (car) {
                        Swal.fire({
                            title: 'Order Placed!',
                            text: 'Your cart has been successfully submitted.',
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: false
                        });
                        $('#shoppingCartId').html('<div class="alert alert-success">Thank you for your purchase!</div>');

                        // Optionally redirect
                        // setTimeout(() => window.location.href = 'thankyou.html', 3000);
                    },
                    error: function (xhr) {
                        let msg = "Failed to complete the purchase. Please try again.";
                        if (xhr.responseText.includes("already been submitted")) {
                            msg = "This cart has already been submitted.";
                        }

                        Swal.fire({
                            title: 'Oops...',
                            text: msg,
                            icon: 'error',
                            confirmButtonText: 'Retry'
                        });
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log("ADDRESS ERROR:", { country, state, zip, address });
                Swal.fire({
                    title: 'Location Error',
                    text: 'Could not save your location info. Please check the input.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
        } 
        else {
            Swal.fire({
                title: 'Missing Information',
                text: 'Please complete all location fields before placing your order.',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
        }
    });
}





})

    </script>

<script>
    $(function(){
        $("#//").load("Basics/instagram.html");
        $("#mainfooterplaceholder").load("Basics/mainFooter.html");
        $("#navPlaceholder").load("Basics/nav.html")
    });
</script>

    <!-- ALL JS FILES -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- ALL PLUGINS -->
    <script src="js/jquery.superslides.min.js"></script>
    <script src="js/bootstrap-select.js"></script>
    <script src="js/inewsticker.js"></script>
    <script src="js/bootsnav.js."></script>
    <script src="js/images-loded.min.js"></script>
    <script src="js/isotope.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/baguetteBox.min.js"></script>
    <script src="js/form-validator.min.js"></script>
    <script src="js/contact-form-script.js"></script>
    <script src="js/custom.js"></script>
</body>

</html>